<!DOCTYPE html>  <html> <head>   <title>Generate.hs</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Generate.hs             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This module keeps track of the probabilities of a word following two other
words. This can be used to generate a third item from a sequence of two
items, and by extension, a string of many items.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">module</span> <span class="nn">Text.Ribot.Generate</span>
    <span class="p">(</span> <span class="kt">TextGenerator</span>
    <span class="p">,</span> <span class="nf">mkTextGenerator</span>
    <span class="p">,</span> <span class="nf">mostLikely</span>
    <span class="p">,</span> <span class="nf">randomContinuation</span>
    <span class="p">,</span> <span class="nf">chain</span>
    <span class="p">,</span> <span class="nf">triples</span>
    <span class="p">,</span> <span class="nf">mimic</span>
    <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Either</span> <span class="k">as</span> <span class="n">E</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.List</span> <span class="k">as</span> <span class="n">L</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">M</span>
<span class="kr">import</span>           <span class="nn">Data.Maybe</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Ord</span> <span class="k">as</span> <span class="n">O</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Set</span> <span class="k">as</span> <span class="n">S</span>
<span class="kr">import</span>           <span class="nn">System.Random</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><a href="Tokenizer.html">Text.Ribot.Tokenizer</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">import</span>           <span class="nn">Text.Ribot.Tokenizer</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This is a frequency map between an item and its frequency.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">type</span> <span class="kt">FreqMap</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="n">a</span> <span class="kt">Int</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This is a mapping between two observations and a <code>FreqMap</code> of the items that
immediately follow it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">type</span> <span class="kt">Model</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">M</span><span class="o">.</span><span class="kt">Map</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="kt">FreqMap</span> <span class="n">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This is the data type for holding the information about the statistical
model. Currently, this is just a stub.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">data</span> <span class="kt">TextGenerator</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">TextGenerator</span> <span class="p">(</span><span class="kt">Model</span> <span class="n">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is the constructor for <code>TextGenerator</code> data. It takes a set of data to
train on and returns the constructed generator.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">mkTextGenerator</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="kt">TextGenerator</span> <span class="n">a</span>
<span class="nf">mkTextGenerator</span> <span class="ow">=</span> <span class="kt">TextGenerator</span> <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">foldl&#39;</span> <span class="n">combine</span> <span class="kt">M</span><span class="o">.</span><span class="n">empty</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This handles one step of the fold.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">combine</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">Model</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Model</span> <span class="n">a</span>
        <span class="n">combine</span> <span class="n">hmm</span> <span class="p">(</span><span class="n">obs1</span><span class="p">,</span> <span class="n">obs2</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="ow">=</span>
            <span class="kt">M</span><span class="o">.</span><span class="n">alter</span> <span class="p">(</span><span class="n">combine&#39;</span> <span class="n">next</span><span class="p">)</span> <span class="p">(</span><span class="n">obs1</span><span class="p">,</span> <span class="n">obs2</span><span class="p">)</span> <span class="n">hmm</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This increments a sequence's <code>FreqMap</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">combine&#39;</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">FreqMap</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="p">(</span><span class="kt">FreqMap</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">combine&#39;</span> <span class="n">item</span> <span class="kt">Nothing</span>   <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="kt">M</span><span class="o">.</span><span class="n">singleton</span> <span class="n">item</span> <span class="mi">1</span>
        <span class="n">combine&#39;</span> <span class="n">item</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">fm</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="o">$</span> <span class="kt">M</span><span class="o">.</span><span class="n">alter</span> <span class="n">incr</span> <span class="n">item</span> <span class="n">fm</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This increments an item's count in a <code>FreqMap</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">incr</span> <span class="ow">::</span> <span class="kt">Maybe</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="kt">Int</span>
        <span class="n">incr</span> <span class="kt">Nothing</span>  <span class="ow">=</span> <span class="kt">Just</span> <span class="mi">1</span>
        <span class="n">incr</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">n</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This returns the continuations for a leading sequence in descending order of
frequency.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">getContinuationList</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">TextGenerator</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)]</span>
<span class="nf">getContinuationList</span> <span class="p">(</span><span class="kt">TextGenerator</span> <span class="n">hmm</span><span class="p">)</span> <span class="n">seq</span> <span class="ow">=</span>
    <span class="n">return</span> <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="kt">O</span><span class="o">.</span><span class="n">comparing</span> <span class="n">key</span><span class="p">)</span> <span class="o">.</span> <span class="kt">M</span><span class="o">.</span><span class="n">toList</span> <span class="o">=&lt;&lt;</span> <span class="kt">M</span><span class="o">.</span><span class="n">lookup</span> <span class="n">seq</span> <span class="n">hmm</span>
    <span class="kr">where</span>
        <span class="n">key</span> <span class="ow">::</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
        <span class="n">key</span> <span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">=</span> <span class="o">-</span><span class="n">i</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>This returns the most likely continuation of the sequence given. If there's
no data for that sequence, <code>Nothing</code> is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">mostLikely</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">TextGenerator</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">a</span>
<span class="nf">mostLikely</span> <span class="n">textGen</span> <span class="n">seq</span> <span class="ow">=</span>
    <span class="n">fmap</span> <span class="n">fst</span> <span class="o">.</span> <span class="n">listToMaybe</span> <span class="o">=&lt;&lt;</span> <span class="n">getContinuationList</span> <span class="n">textGen</span> <span class="n">seq</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This returns a continuation for the sequence. It does using a random
selecting weighted by the frequency of each continuation. If there aren't
any continuations, <code>Nothing</code> is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">randomContinuation</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">TextGenerator</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="n">a</span><span class="p">)</span>
<span class="nf">randomContinuation</span> <span class="n">textGen</span> <span class="n">seq</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="p">(</span><span class="n">getContinuationList</span> <span class="n">textGen</span> <span class="n">seq</span><span class="p">)</span> <span class="kr">of</span>
        <span class="kt">Nothing</span>   <span class="ow">-&gt;</span> <span class="n">return</span> <span class="kt">Nothing</span>
        <span class="kt">Just</span> <span class="n">cont</span> <span class="ow">-&gt;</span> <span class="n">randomIO</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="o">.</span> <span class="n">getWeightedChoice</span> <span class="n">cont</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>This takes a list of items with weights and a percent as a fraction and
returns the item with that weighted amount. It walks through the list and
takes the item for which the running weight total takes it over the weight
fraction passed in.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">getWeightedChoice</span> <span class="ow">::</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="kt">Double</span> <span class="ow">-&gt;</span> <span class="kt">Maybe</span> <span class="n">a</span>
<span class="nf">getWeightedChoice</span> <span class="n">choices</span> <span class="n">cutOff</span> <span class="ow">=</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>This is a mouthful, and you have to read it backwards. Here's what it
does:</p>

<ul>
<li><code>L.mapAccumL accum 0 choices</code> — Convert the weights in the list of
choices into a percentage of the total weights in the list;</li>
<li><code>snd</code> — Drop off the accumulator's state, the running total;</li>
<li><code>L.dropWhile ((&lt; cutOff) . snd)</code> — Remove all of the items from the
front of the list until we get to the item whose running weight total
percentage is at or above the cut off (i.e., remove all the items up to
the one we want);</li>
<li><code>map fst</code> — Remove the running weighted total percentage and save only
the item;</li>
<li><code>listToMaybe</code> — If there is anything in the list, take the head and
wrap it in <code>Just</code>; otherwise, return <code>Nothing</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="n">listToMaybe</span>
        <span class="o">.</span> <span class="n">map</span> <span class="n">fst</span>
        <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">dropWhile</span> <span class="p">((</span><span class="o">&lt;</span> <span class="n">cutOff</span><span class="p">)</span> <span class="o">.</span> <span class="n">snd</span><span class="p">)</span>
        <span class="o">.</span> <span class="n">snd</span>
        <span class="o">$</span> <span class="kt">L</span><span class="o">.</span><span class="n">mapAccumL</span> <span class="n">accum</span> <span class="mi">0</span> <span class="n">choices</span>

    <span class="kr">where</span>
        <span class="n">total</span> <span class="ow">=</span> <span class="n">fromIntegral</span> <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">sum</span> <span class="o">$</span> <span class="n">map</span> <span class="n">snd</span> <span class="n">choices</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This handles accumulating the running total information. It takes
each pair from the choice list and replaces the weight with the
running percentage of the weight totals.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">accum</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="kt">Double</span><span class="p">))</span>
        <span class="n">accum</span> <span class="n">running</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span> <span class="ow">=</span>
            <span class="p">(</span><span class="n">running&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="n">fromIntegral</span> <span class="n">running&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
            <span class="kr">where</span> <span class="n">running&#39;</span> <span class="ow">=</span> <span class="n">running</span> <span class="o">+</span> <span class="n">weight</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>This creates a chain of items. The item given is the item to use for
placeholders at the beginning and end of sequences. The number is the number
of tokens to output in the sequence.</p>

<p>First, this will get all the sequences in the generator that start with the
initial character. It then picks one at random. From there, it keeps calling
<code>randomConintuation</code> until it doesn't need more items.</p>

<p>This is kind of messy. I'm not very happy with it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">chain</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">Show</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="kt">TextGenerator</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
<span class="nf">chain</span> <span class="n">textGen</span><span class="o">@</span><span class="p">(</span><span class="kt">TextGenerator</span> <span class="n">tg</span><span class="p">)</span> <span class="n">start</span> <span class="n">n</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="p">(</span><span class="kr">_</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">randomElem</span> <span class="n">nextPairs</span>
    <span class="n">return</span> <span class="o">.</span> <span class="n">filter</span> <span class="p">(</span><span class="o">/=</span> <span class="n">start</span><span class="p">)</span> <span class="o">=&lt;&lt;</span> <span class="n">chain&#39;</span> <span class="n">textGen</span> <span class="n">start</span> <span class="n">start</span> <span class="n">next</span> <span class="n">n</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This is a list of all the sequences in the model that begin with
<code>start</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">nextPairs</span> <span class="ow">=</span> <span class="kt">L</span><span class="o">.</span><span class="n">filter</span> <span class="p">((</span><span class="n">start</span> <span class="o">==</span><span class="p">)</span> <span class="o">.</span> <span class="n">fst</span><span class="p">)</span> <span class="o">$</span> <span class="kt">M</span><span class="o">.</span><span class="n">keys</span> <span class="n">tg</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This is a set of all the options. It's used to randomly select a
continuation for where there are holes in the model.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">itemSet</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">b</span> <span class="ow">=&gt;</span> <span class="kt">Model</span> <span class="n">b</span> <span class="ow">-&gt;</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Set</span> <span class="n">b</span>
        <span class="n">itemSet</span> <span class="n">m</span> <span class="ow">=</span> <span class="kt">S</span><span class="o">.</span><span class="n">fromList</span> <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">concatMap</span> <span class="p">(</span><span class="n">uncurry</span> <span class="n">getItems</span><span class="p">)</span> <span class="o">$</span> <span class="kt">M</span><span class="o">.</span><span class="n">toList</span> <span class="n">m</span>
            <span class="kr">where</span>
                <span class="n">getItems</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">FreqMap</span> <span class="n">c</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">getItems</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span> <span class="n">freqMap</span> <span class="ow">=</span> <span class="n">t1</span> <span class="kt">:</span> <span class="n">t2</span> <span class="kt">:</span> <span class="kt">M</span><span class="o">.</span><span class="n">keys</span> <span class="n">freqMap</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Just <code>itemSet</code> as a list so we can easily pick one at random.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">itemList</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">d</span> <span class="ow">=&gt;</span> <span class="kt">Model</span> <span class="n">d</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="n">itemList</span> <span class="ow">=</span> <span class="kt">S</span><span class="o">.</span><span class="n">toList</span> <span class="o">.</span> <span class="n">itemSet</span>

        <span class="n">randomElem</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">a</span>
        <span class="n">randomElem</span> <span class="n">list</span> <span class="ow">=</span>
            <span class="n">randomRIO</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="n">list</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="o">.</span> <span class="p">(</span><span class="n">list</span> <span class="o">!!</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This constructs a list/stream that pulls.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">chain&#39;</span> <span class="ow">::</span> <span class="kt">Ord</span> <span class="n">e</span> <span class="ow">=&gt;</span> <span class="kt">Show</span> <span class="n">e</span> <span class="ow">=&gt;</span> <span class="kt">Eq</span> <span class="n">e</span> <span class="ow">=&gt;</span>
                  <span class="kt">TextGenerator</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">e</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="n">chain&#39;</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="mi">0</span> <span class="ow">=</span> <span class="n">return</span> <span class="kt">[]</span>
        <span class="n">chain&#39;</span> <span class="n">tg</span><span class="o">@</span><span class="p">(</span><span class="kt">TextGenerator</span> <span class="n">m</span><span class="p">)</span> <span class="n">filterOut</span> <span class="n">token1</span> <span class="n">token2</span> <span class="n">n</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">contMaybe</span> <span class="ow">&lt;-</span> <span class="n">randomContinuation</span> <span class="n">tg</span> <span class="p">(</span><span class="n">token1</span><span class="p">,</span> <span class="n">token2</span><span class="p">)</span>
            <span class="kr">case</span> <span class="n">contMaybe</span> <span class="kr">of</span>
                <span class="kt">Just</span> <span class="n">token3</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
                    <span class="n">rest</span> <span class="ow">&lt;-</span> <span class="n">chain&#39;</span> <span class="n">tg</span> <span class="n">filterOut</span> <span class="n">token2</span> <span class="n">token3</span> <span class="n">n&#39;</span>
                    <span class="n">return</span> <span class="p">(</span><span class="n">token1</span> <span class="kt">:</span> <span class="n">rest</span><span class="p">)</span>
                <span class="kt">Nothing</span>     <span class="ow">-&gt;</span> <span class="kr">do</span>
                    <span class="n">token3</span> <span class="ow">&lt;-</span> <span class="n">randomElem</span> <span class="p">(</span><span class="n">itemList</span> <span class="n">m</span><span class="p">)</span>
                    <span class="n">rest</span>   <span class="ow">&lt;-</span> <span class="n">chain&#39;</span> <span class="n">tg</span> <span class="n">filterOut</span> <span class="n">token2</span> <span class="n">token3</span> <span class="n">n&#39;</span>
                    <span class="n">return</span> <span class="p">(</span><span class="n">token1</span> <span class="kt">:</span> <span class="n">rest</span><span class="p">)</span>
            <span class="kr">where</span> <span class="n">n&#39;</span> <span class="ow">=</span> <span class="kr">if</span> <span class="p">(</span><span class="n">token1</span> <span class="o">==</span> <span class="n">filterOut</span><span class="p">)</span>
                       <span class="kr">then</span> <span class="n">n</span>
                       <span class="kr">else</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>This breaks a list of items into a list of overlapping triples. The first
position is for a boundary marker, so this call,</p>

<pre><code>triples -1 [1..5]
[(-1, -1, 1), (-1, 1, 2), (1, 2, 3), (2, 3, 4), (3, 4, 5), (4, 5, -1),
 (5, -1, -1)]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">triples</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)]</span>
<span class="nf">triples</span> <span class="n">fill</span> <span class="n">xs</span> <span class="ow">=</span> <span class="kt">L</span><span class="o">.</span><span class="n">zip3</span> <span class="n">xxs</span> <span class="p">(</span><span class="kt">L</span><span class="o">.</span><span class="n">drop</span> <span class="mi">1</span> <span class="n">xxs</span><span class="p">)</span> <span class="p">(</span><span class="kt">L</span><span class="o">.</span><span class="n">drop</span> <span class="mi">2</span> <span class="n">xxs</span><span class="p">)</span>
    <span class="kr">where</span> <span class="n">xxs</span> <span class="ow">=</span> <span class="p">(</span><span class="n">fill</span> <span class="kt">:</span> <span class="n">fill</span> <span class="kt">:</span> <span class="n">xs</span><span class="p">)</span> <span class="o">++</span> <span class="p">[</span><span class="n">fill</span><span class="p">,</span> <span class="n">fill</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This takes a list of message texts and a number of items to generate. It
tokenizes the messages, breaks them into triples, and creates a
<code>TextGenerator</code> from that data. It uses that generator to assemble a
mimicking utterance for the person.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">mimic</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
<span class="nf">mimic</span> <span class="kt">[]</span>     <span class="kr">_</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">[</span><span class="s">&quot;Hmm. That person hasn&#39;t said anything.&quot;</span><span class="p">]</span>
<span class="nf">mimic</span> <span class="n">inputs</span> <span class="n">n</span> <span class="ow">=</span> <span class="n">chain</span> <span class="n">tg</span> <span class="s">&quot;#&quot;</span> <span class="n">n</span>
    <span class="kr">where</span>
        <span class="n">tokens</span> <span class="ow">=</span> <span class="kt">E</span><span class="o">.</span><span class="n">rights</span> <span class="o">.</span> <span class="n">map</span> <span class="p">(</span><span class="n">tokenize</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">$</span> <span class="n">inputs</span>
        <span class="n">trips</span>  <span class="ow">=</span> <span class="kt">L</span><span class="o">.</span><span class="n">concatMap</span> <span class="p">(</span><span class="n">triples</span> <span class="s">&quot;#&quot;</span><span class="p">)</span> <span class="n">tokens</span>
        <span class="n">tg</span><span class="o">@</span><span class="p">(</span><span class="kt">TextGenerator</span> <span class="n">m</span><span class="p">)</span> <span class="ow">=</span> <span class="n">mkTextGenerator</span> <span class="n">trips</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 