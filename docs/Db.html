<!DOCTYPE html>  <html> <head>   <title>Db.hs</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Db.hs             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This contains the functions to interface with the database and to access it.</p>

<p>Ribot uses the database to log messages and it implements an inverted index
on it. (I could probably use SQLite's own extension for this, but it seemed
marginally more interesting to roll my own. I thought that there may be
problems making sure the extension is available on the thousands of machines
I expect to run Ribot on.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">module</span> <span class="nn">Network.Ribot.Db</span>
    <span class="p">(</span> <span class="nf">connectDb</span>
    <span class="p">,</span> <span class="kt">IConnection</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
    <span class="p">,</span> <span class="kt">ConnWrapper</span>
    <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Database.HDBC</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC.Types</span> <span class="p">(</span><span class="kt">IConnection</span><span class="p">(</span><span class="o">..</span><span class="p">),</span> <span class="kt">ConnWrapper</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC.Sqlite3</span> <span class="p">(</span><span class="nf">connectSqlite3</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">System.Directory</span>
<span class="kr">import</span>           <span class="nn">System.FilePath</span> <span class="p">((</span><span class="o">&lt;/&gt;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This connects to the database. It returns a ConnWrapper in order to provide
some flexibility in what database engine I use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">connectDb</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="kt">ConnWrapper</span>
<span class="nf">connectDb</span> <span class="ow">=</span> <span class="n">findDbFile</span> <span class="o">&gt;&gt;=</span> <span class="n">connectSqlite3</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="o">.</span> <span class="kt">ConnWrapper</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This finds the database filename. It looks in the user application
directory.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">findDbFile</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="kt">FilePath</span>
<span class="nf">findDbFile</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">appDir</span> <span class="ow">&lt;-</span> <span class="n">getAppUserDataDirectory</span> <span class="s">&quot;ribot&quot;</span>
    <span class="n">createDirectoryIfMissing</span> <span class="kt">True</span> <span class="n">appDir</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">appDir</span> <span class="o">&lt;/&gt;</span> <span class="s">&quot;ribot.db&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 