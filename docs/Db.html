<!DOCTYPE html>  <html> <head>   <title>Db.hs</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Db.hs             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This contains the functions to interface with the database and to access it.</p>

<p>Ribot uses the database to log messages and it implements an inverted index
on it. (I could probably use SQLite's own extension for this, but it seemed
marginally more interesting to roll my own. I thought that there may be
problems making sure the extension is available on the thousands of machines
I expect to run Ribot on.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">module</span> <span class="nn">Network.Ribot.Db</span>
    <span class="p">(</span> <span class="nf">connectDb</span>
    <span class="p">,</span> <span class="kt">IConnection</span><span class="p">(</span><span class="o">..</span><span class="p">)</span>
    <span class="p">,</span> <span class="kt">ConnWrapper</span>
    <span class="p">,</span> <span class="nf">logMessage</span>
    <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">forM</span><span class="p">,</span> <span class="nf">forM_</span><span class="p">,</span> <span class="nf">mapM</span><span class="p">,</span> <span class="nf">mapM_</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC.Types</span> <span class="p">(</span><span class="kt">IConnection</span><span class="p">(</span><span class="o">..</span><span class="p">),</span> <span class="kt">ConnWrapper</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC.Sqlite3</span> <span class="p">(</span><span class="nf">connectSqlite3</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Network.Ribot.Message</span>
<span class="kr">import</span>           <span class="nn">System.Directory</span>
<span class="kr">import</span>           <span class="nn">System.FilePath</span> <span class="p">((</span><span class="o">&lt;/&gt;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This connects to the database. It returns a ConnWrapper in order to provide
some flexibility in what database engine I use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">connectDb</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="kt">ConnWrapper</span>
<span class="nf">connectDb</span> <span class="ow">=</span>   <span class="n">findDbFile</span>
          <span class="o">&gt;&gt;=</span> <span class="n">connectSqlite3</span>
          <span class="o">&gt;&gt;=</span> <span class="n">initDb</span>
          <span class="o">&gt;&gt;=</span> <span class="n">createDb</span>
          <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="o">.</span> <span class="kt">ConnWrapper</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This initializes the database by turning on appropriate pragmas.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">initDb</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">c</span>
<span class="nf">initDb</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">runRaw</span> <span class="n">cxn</span> <span class="s">&quot;PRAGMA foreign_keys = ON;&quot;</span>
    <span class="n">return</span> <span class="n">cxn</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This creates the database schema and returns the database connection so it
can be used for piping.</p>

<p>(I'm almost certain there's a one-liner for the main definition of this
function, but it's eluding me. I'll have to re-visit this once I have more
Haskell-fu.)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">createDb</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="n">c</span>
<span class="nf">createDb</span> <span class="ow">=</span>
    <span class="p">(</span><span class="n">flip</span> <span class="n">withTransaction</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="n">cxn</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">forM_</span> <span class="n">sql</span> <span class="o">$</span> <span class="p">(</span><span class="n">runRaw</span> <span class="n">cxn</span><span class="p">)</span>
        <span class="n">return</span> <span class="n">cxn</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Here are the statements, packaged up so run by create.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">sql</span> <span class="ow">=</span> <span class="p">[</span> <span class="s">&quot;CREATE TABLE IF NOT EXISTS user ( </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> username TEXT </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> );&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE TABLE IF NOT EXISTS message ( </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> user_id INTEGER, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> text TEXT, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> posted DATETIME, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> FOREIGN KEY (user_id) REFERENCES user(id) </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> );&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE TABLE IF NOT EXISTS token ( </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> text TEXT </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> );&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE TABLE IF NOT EXISTS position ( </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> id INTEGER PRIMARY KEY, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> token_id INTEGER, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> message_id INTEGER, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> offset INTEGER, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> length INTEGER, </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> FOREIGN KEY (token_id) REFERENCES token(id), </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> FOREIGN KEY (message_id) REFERENCES message(id) </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> );&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE UNIQUE INDEX IF NOT EXISTS idx_user ON user </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> (username);&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE INDEX IF NOT EXISTS idx_message ON message </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> (id, user_id, posted);&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE INDEX IF NOT EXISTS idx_token ON token (id, text);&quot;</span>
              <span class="p">,</span> <span class="s">&quot;CREATE INDEX IF NOT EXISTS idx_position ON position </span><span class="se">\</span>
<span class="se">                        \</span><span class="s"> (id, token_id, message_id);&quot;</span>
              <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This finds the database filename. It looks in the user application
directory.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">findDbFile</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="kt">FilePath</span>
<span class="nf">findDbFile</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">appDir</span> <span class="ow">&lt;-</span> <span class="n">getAppUserDataDirectory</span> <span class="s">&quot;ribot&quot;</span>
    <span class="n">createDirectoryIfMissing</span> <span class="kt">True</span> <span class="n">appDir</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">appDir</span> <span class="o">&lt;/&gt;</span> <span class="s">&quot;ribot.db&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This saves a message to the database. This doesn't handle the transaction.
You probably want to do that at a higher level.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">logMessage</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="kt">Message</span> <span class="ow">-&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">logMessage</span> <span class="n">msg</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If there's no user, move on.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kr">case</span> <span class="p">(</span><span class="n">msgUser</span> <span class="n">msg</span><span class="p">)</span> <span class="kr">of</span>
        <span class="kt">Just</span> <span class="n">userName</span> <span class="ow">-&gt;</span> <span class="n">addMsg</span> <span class="n">userName</span> <span class="o">$</span> <span class="n">msgText</span> <span class="n">msg</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">return</span> <span class="nb">()</span>

    <span class="kr">where</span>
        <span class="n">addMsg</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">addMsg</span> <span class="n">userName</span> <span class="n">msgStr</span> <span class="ow">=</span> <span class="kr">do</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>First, try to create the user, if the name isn't already in the db.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">run</span> <span class="n">cxn</span> <span class="s">&quot;INSERT OR IGNORE INTO user (username) VALUES (?);&quot;</span> <span class="p">[</span><span class="n">toSql</span> <span class="n">userName</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Second, add the message to the database.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">run</span> <span class="n">cxn</span> <span class="s">&quot;INSERT INTO message (user_id, text, posted) </span><span class="se">\</span>
<span class="se">                \</span><span class="s"> SELECT id, DATETIME(&#39;NOW&#39;), ? </span><span class="se">\</span>
<span class="se">                \</span><span class="s"> FROM user WHERE username=?;&quot;</span>
                <span class="p">[</span><span class="n">toSql</span> <span class="n">msgStr</span><span class="p">,</span> <span class="n">toSql</span> <span class="n">userName</span><span class="p">]</span>

            <span class="n">return</span> <span class="nb">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 