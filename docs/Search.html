<!DOCTYPE html>  <html> <head>   <title>Search.hs</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Search.hs             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This module contains functions related to indexing and searching messages.</p>

<p>The search engine is intentionally basic, and probably won't scale well.
However, it should be dead-simple to get going. This just uses an inverted
index based on the database tables <code>token</code> and <code>position</code>, pointing to rows
in the table <code>message</code>.</p>

<p>NB: The <code>position</code> table implies that this is a word-level index, but
actually it's a document-level (i.e., message-level) index.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">module</span> <span class="nn">Network.Ribot.Search</span>
    <span class="p">(</span> <span class="nf">index</span>
    <span class="p">,</span> <span class="nf">tokenize</span>
    <span class="p">,</span> <span class="nf">reindex</span>
    <span class="p">,</span> <span class="nf">search</span>
    <span class="p">,</span> <span class="nf">parseSearch</span>
    <span class="p">,</span> <span class="nf">buildQuery</span>
    <span class="p">,</span> <span class="kt">SearchResult</span>
    <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">mapM_</span><span class="p">)</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Char</span> <span class="k">as</span> <span class="n">C</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.List</span> <span class="k">as</span> <span class="n">L</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC.Types</span> <span class="p">(</span><span class="kt">IConnection</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Text.ParserCombinators.Parsec</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.Ribot.Tokenizer</span> <span class="k">as</span> <span class="n">T</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This takes a database connection, message ID, and message string. It
tokenizes and cleans up the string, and indexes the string. It returns the
token ized, cleaned up message.</p>

<p>The index is populated using these steps:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">index</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
<span class="nf">index</span> <span class="n">cxn</span> <span class="n">nick</span> <span class="n">msgId</span> <span class="n">msg</span> <span class="ow">=</span>
    <span class="n">withTransaction</span> <span class="n">cxn</span> <span class="o">$</span> <span class="nf">\</span><span class="n">cxn</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">loadTokens</span> <span class="n">cxn</span>
        <span class="n">updateTokenTable</span> <span class="n">cxn</span>
        <span class="n">updateIds</span> <span class="n">cxn</span>
        <span class="n">updateIndex</span> <span class="n">cxn</span>
        <span class="n">cleanUp</span> <span class="n">cxn</span>
        <span class="n">return</span> <span class="n">tokens</span>
    <span class="kr">where</span>
        <span class="n">tokens</span> <span class="ow">=</span> <span class="n">tokenize</span> <span class="n">nick</span> <span class="n">msg</span>
        <span class="n">tokenValues</span> <span class="ow">=</span> <span class="p">[[</span><span class="n">msgIdSql</span><span class="p">,</span> <span class="n">toSql</span> <span class="n">tkn</span><span class="p">]</span> <span class="o">|</span> <span class="n">tkn</span> <span class="ow">&lt;-</span> <span class="n">tokens</span><span class="p">]</span>
        <span class="n">msgIdSql</span> <span class="ow">=</span> <span class="n">toSql</span> <span class="n">msgId</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ol>
<li>The tokens are loaded into the temporary table;</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">loadTokens</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">loadTokens</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot;INSERT OR IGNORE INTO msg_token </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> (message_id, text) VALUES (?, ?);&quot;</span>
            <span class="n">executeMany</span> <span class="n">stmt</span> <span class="n">tokenValues</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ol>
<li><code>token</code> is updated with the tokens in the temporary table
(<code>INSERT OR IGNORE</code>);</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateTokenTable</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateTokenTable</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot;INSERT OR IGNORE INTO token (text) </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> SELECT text FROM msg_token </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> WHERE message_id=?;&quot;</span>
            <span class="n">execute</span> <span class="n">stmt</span> <span class="p">[</span><span class="n">msgIdSql</span><span class="p">]</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <ol>
<li>The IDs in the temporary table are filled in from the <code>token</code>
table;</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateIds</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateIds</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot;INSERT OR REPLACE INTO msg_token </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> (token_id, message_id, text) </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> SELECT t.id, mt.message_id, t.text </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> FROM token t </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> JOIN msg_token mt ON mt.text=t.text </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> WHERE mt.message_id=?;&quot;</span>
            <span class="n">execute</span> <span class="n">stmt</span> <span class="p">[</span><span class="n">msgIdSql</span><span class="p">]</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <ol>
<li>The tokens in the temporary table are inserted into the
<code>position</code> table; and</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateIndex</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateIndex</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot;INSERT INTO position (token_id, message_id) </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> SELECT token_id, message_id FROM msg_token </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> WHERE message_id=?;&quot;</span>
            <span class="n">execute</span> <span class="n">stmt</span> <span class="p">[</span><span class="n">msgIdSql</span><span class="p">]</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <ol>
<li>Remove the tokens from this message from the temporary table.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">cleanUp</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">cleanUp</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot;DELETE FROM msg_token WHERE message_id=?;&quot;</span>
            <span class="n">execute</span> <span class="n">stmt</span> <span class="p">[</span><span class="n">msgIdSql</span><span class="p">]</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This takes an input string and tokenizes it and removes stop words and
punctuation. The parameters are the user's nick and the message.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">tokenize</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
<span class="nf">tokenize</span> <span class="n">nick</span> <span class="n">input</span> <span class="ow">=</span> 
    <span class="kr">case</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">tokenize</span> <span class="n">nick</span> <span class="n">input</span><span class="p">)</span> <span class="kr">of</span>
        <span class="kt">Left</span> <span class="kr">_</span>    <span class="ow">-&gt;</span> <span class="kt">[]</span>
        <span class="kt">Right</span> <span class="n">all</span> <span class="ow">-&gt;</span> <span class="kt">L</span><span class="o">.</span><span class="n">filter</span> <span class="n">keep</span> <span class="n">all</span>
    <span class="kr">where</span>
        <span class="n">keep</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
        <span class="n">keep</span> <span class="n">word</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="n">isWord</span> <span class="n">word</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">inStopList</span> <span class="n">word</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This takes a database connection and it re-indexes the entire set of
messages it contains. It returns the number of messages indexed and the
number of tokens indexed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">reindex</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Int</span><span class="p">)</span>
<span class="nf">reindex</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">withTransaction</span> <span class="n">cxn</span> <span class="o">$</span> <span class="nf">\</span><span class="n">cxn</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">clearExistingData</span> <span class="n">cxn</span>

        <span class="n">msgs</span> <span class="ow">&lt;-</span> <span class="n">getMessages</span> <span class="n">cxn</span>
        <span class="kr">let</span> <span class="n">tokens</span> <span class="ow">=</span> <span class="n">tokenizeMessages</span> <span class="n">msgs</span>

        <span class="n">populateMsgTokenTable</span> <span class="n">cxn</span> <span class="n">tokens</span>
        <span class="n">updateTokenTable</span> <span class="n">cxn</span>
        <span class="n">updateIds</span> <span class="n">cxn</span>
        <span class="n">updateIndex</span> <span class="n">cxn</span>

        <span class="n">cleanUp</span> <span class="n">cxn</span>
        <span class="n">return</span> <span class="p">(</span><span class="n">length</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">length</span> <span class="n">tokens</span><span class="p">)</span>

    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ol>
<li>First, we have to clear out the existing data from the <code>token</code>
and <code>position</code> tables;</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">clearExistingData</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">clearExistingData</span> <span class="n">cxn</span> <span class="ow">=</span>
            <span class="n">mapM_</span> <span class="p">(</span><span class="n">runRaw</span> <span class="n">cxn</span><span class="p">)</span> <span class="p">[</span> <span class="s">&quot;DELETE FROM token;&quot;</span>
                               <span class="p">,</span> <span class="s">&quot;DELETE FROM position;&quot;</span>
                               <span class="p">,</span> <span class="s">&quot;DELETE FROM msg_token;&quot;</span>
                               <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ol>
<li>Get all messages (Message ID, User Nick, Message Text);</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">getMessages</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">)]</span>
        <span class="n">getMessages</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">results</span> <span class="ow">&lt;-</span> <span class="n">quickQuery&#39;</span> <span class="n">cxn</span>
                                   <span class="s">&quot; SELECT m.id, u.username, m.text </span><span class="se">\</span>
<span class="se">                                   \</span><span class="s"> FROM message m </span><span class="se">\</span>
<span class="se">                                   \</span><span class="s"> JOIN user u ON u.id=m.user_id;&quot;</span>
                                   <span class="kt">[]</span>
            <span class="n">return</span> <span class="p">[(</span><span class="n">fromSql</span> <span class="n">mId</span><span class="p">,</span> <span class="n">fromSql</span> <span class="n">userName</span><span class="p">,</span> <span class="n">fromSql</span> <span class="n">msgText</span><span class="p">)</span> <span class="o">|</span>
                    <span class="p">[</span><span class="n">mId</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">msgText</span><span class="p">]</span> <span class="ow">&lt;-</span> <span class="n">results</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ol>
<li>Tokenize them (output of <code>getMessages</code> -> (mId, tokenText));</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">tokenizeMessages</span> <span class="ow">::</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">)]</span>
        <span class="n">tokenizeMessages</span> <span class="ow">=</span> <span class="kt">L</span><span class="o">.</span><span class="n">concatMap</span> <span class="n">tokenizeMessage</span>

        <span class="n">tokenizeMessage</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">)]</span>
        <span class="n">tokenizeMessage</span> <span class="p">(</span><span class="n">msgId</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">msgText</span><span class="p">)</span> <span class="ow">=</span>
            <span class="n">map</span> <span class="p">((,)</span> <span class="n">msgId</span><span class="p">)</span> <span class="o">$</span> <span class="n">tokenize</span> <span class="n">nick</span> <span class="n">msgText</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ol>
<li>Push the tokens into <code>msg_token</code>;</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">populateMsgTokenTable</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">[(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">)]</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">populateMsgTokenTable</span> <span class="n">cxn</span> <span class="n">tokens</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">stmt</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot; INSERT OR IGNORE INTO msg_token </span><span class="se">\</span>
<span class="se">                                \</span><span class="s"> (message_id, text) VALUES (?, ?);&quot;</span>
            <span class="n">executeMany</span> <span class="n">stmt</span> <span class="p">[[</span><span class="n">toSql</span> <span class="n">msgId</span><span class="p">,</span> <span class="n">toSql</span> <span class="n">token</span><span class="p">]</span> <span class="o">|</span>
                              <span class="p">(</span><span class="n">msgId</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">tokens</span><span class="p">]</span>
            <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <ol>
<li>Fill in the <code>token</code> table;</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateTokenTable</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateTokenTable</span> <span class="n">cxn</span> <span class="ow">=</span>
            <span class="n">runRaw</span> <span class="n">cxn</span> <span class="s">&quot; INSERT OR IGNORE INTO token (text) </span><span class="se">\</span>
<span class="se">                       \</span><span class="s"> SELECT text FROM msg_token;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <ol>
<li>Pull the token IDs back into <code>msg_token</code> (unfortunately, I can't
figure out a way to do this in SQL without <code>UPDATE ... SELECT</code>);</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateIds</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateIds</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">tokens</span> <span class="ow">&lt;-</span> <span class="n">quickQuery&#39;</span> <span class="n">cxn</span> <span class="s">&quot;SELECT id, text FROM token;&quot;</span> <span class="kt">[]</span>
            <span class="n">update</span> <span class="ow">&lt;-</span> <span class="n">prepare</span> <span class="n">cxn</span> <span class="s">&quot; UPDATE msg_token </span><span class="se">\</span>
<span class="se">                                  \</span><span class="s"> SET token_id=? WHERE text=?;&quot;</span>
            <span class="n">executeMany</span> <span class="n">update</span> <span class="n">tokens</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <ol>
<li>Push the token/message relationships into <code>position</code>; and</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">updateIndex</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">updateIndex</span> <span class="n">cxn</span> <span class="ow">=</span>
            <span class="n">runRaw</span> <span class="n">cxn</span> <span class="s">&quot; INSERT INTO position (token_id, message_id) </span><span class="se">\</span>
<span class="se">                       \</span><span class="s"> SELECT token_id, message_id FROM msg_token; &quot;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <ol>
<li>Remove the working data from the <code>msg_token</code> table.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">cleanUp</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">a</span> <span class="ow">=&gt;</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
        <span class="n">cleanUp</span> <span class="n">cxn</span> <span class="ow">=</span>
            <span class="n">runRaw</span> <span class="n">cxn</span> <span class="s">&quot;DELETE FROM msg_token;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>A <code>SearchResult</code> is one hit from a search query. It contains
1. the message ID,
2. the nick of the person who sent the message,
3. the date the message was sent, and
4. the message text.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">type</span> <span class="kt">SearchResult</span> <span class="ow">=</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">String</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>This parses a search query, turns it into SQL, passes it to the database,
parses the results into a list of <code>SearchResult</code>s and returns them.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">search</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">[</span><span class="kt">SearchResult</span><span class="p">]</span>
<span class="nf">search</span> <span class="n">cxn</span> <span class="n">query</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">fmap</span> <span class="p">(</span><span class="n">map</span> <span class="n">toSearchResult</span><span class="p">)</span> <span class="o">$</span> <span class="n">quickQuery&#39;</span> <span class="n">cxn</span> <span class="n">sql</span> <span class="n">params</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>These are the SQL query to run and its parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">=</span> <span class="n">buildQuery</span> <span class="o">$</span> <span class="n">parseSearch</span> <span class="n">query</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>This converts a result row to a <code>SearchResult</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">toSearchResult</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">SqlValue</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">SearchResult</span>
        <span class="n">toSearchResult</span> <span class="p">[</span><span class="n">mId</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">posted</span><span class="p">,</span> <span class="n">mText</span><span class="p">]</span> <span class="ow">=</span>
            <span class="p">(</span> <span class="n">fromSql</span> <span class="n">mId</span>
            <span class="p">,</span> <span class="n">fromSql</span> <span class="n">userName</span>
            <span class="p">,</span> <span class="n">fromSql</span> <span class="n">posted</span>
            <span class="p">,</span> <span class="n">fromSql</span> <span class="n">mText</span>
            <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Parse search parses the search query according to these rules:
* for the most part, tokenization follows <code>tokenize</code> above;
* English stop words and punctuation are stripped out; and
* wildcards (stars) are turned into SQL wildcards (<em>%</em>).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">parseSearch</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
<span class="nf">parseSearch</span> <span class="n">input</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="p">(</span><span class="n">tokenizeQuery</span> <span class="s">&quot;&lt;query&gt;&quot;</span> <span class="n">input</span><span class="p">)</span> <span class="kr">of</span>
        <span class="kt">Left</span> <span class="kr">_</span>    <span class="ow">-&gt;</span> <span class="kt">[]</span>
        <span class="kt">Right</span> <span class="n">all</span> <span class="ow">-&gt;</span> <span class="n">map</span> <span class="n">normalize</span> <span class="o">$</span> <span class="kt">L</span><span class="o">.</span><span class="n">filter</span> <span class="n">keep</span> <span class="n">all</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This handles interacting with the parser.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">tokenizeQuery</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Either</span> <span class="kt">ParseError</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
        <span class="n">tokenizeQuery</span> <span class="ow">=</span> <span class="n">parse</span> <span class="n">tokenList</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>This is a predicate defining the tokens that need to be kept.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">keep</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
        <span class="n">keep</span> <span class="ow">=</span> <span class="n">not</span> <span class="o">.</span> <span class="kt">T</span><span class="o">.</span><span class="n">inStopList</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>This fixes the wildcard characters in a string and lower-cases the
characters.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">normalize</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
        <span class="n">normalize</span> <span class="kt">[]</span>       <span class="ow">=</span> <span class="kt">[]</span>
        <span class="n">normalize</span> <span class="p">(</span><span class="sc">&#39;*&#39;</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="sc">&#39;%&#39;</span> <span class="kt">:</span> <span class="n">normalize</span> <span class="n">xs</span>
        <span class="n">normalize</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span>   <span class="ow">=</span> <span class="p">(</span><span class="kt">C</span><span class="o">.</span><span class="n">toLower</span> <span class="n">x</span><span class="p">)</span> <span class="kt">:</span> <span class="p">(</span><span class="n">normalize</span> <span class="n">xs</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>This defines a list of tokens.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">tokenList</span> <span class="ow">::</span> <span class="kt">GenParser</span> <span class="kt">Char</span> <span class="n">st</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
        <span class="n">tokenList</span> <span class="ow">=</span> <span class="n">word</span> <span class="p">`</span><span class="n">sepBy</span><span class="p">`</span> <span class="n">many</span> <span class="p">(</span><span class="n">satisfy</span> <span class="n">isJunk</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A single token. This is where it differs from
<code>Text.Ribot.Tokenizer</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">word</span> <span class="ow">::</span> <span class="kt">GenParser</span> <span class="kt">Char</span> <span class="n">st</span> <span class="kt">String</span>
        <span class="n">word</span> <span class="ow">=</span> <span class="kr">do</span>
            <span class="n">first</span> <span class="ow">&lt;-</span> <span class="n">alphaNum</span> <span class="o">&lt;|&gt;</span> <span class="n">char</span> <span class="sc">&#39;*&#39;</span>
            <span class="n">rest</span> <span class="ow">&lt;-</span> <span class="n">many</span> <span class="p">(</span><span class="n">alphaNum</span> <span class="o">&lt;|&gt;</span> <span class="n">char</span> <span class="sc">&#39;*&#39;</span> <span class="o">&lt;|&gt;</span> <span class="n">oneOf</span> <span class="s">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">return</span> <span class="p">(</span><span class="n">first</span><span class="kt">:</span><span class="n">rest</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>This is a predicate defining a junk character. It's basically a
predicate inverse of <code>word</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">isJunk</span> <span class="ow">::</span> <span class="kt">Char</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span>
        <span class="n">isJunk</span> <span class="sc">&#39;*&#39;</span>                <span class="ow">=</span> <span class="kt">False</span>
        <span class="n">isJunk</span> <span class="n">c</span> <span class="o">|</span> <span class="kt">C</span><span class="o">.</span><span class="n">isAlphaNum</span> <span class="n">c</span> <span class="ow">=</span> <span class="kt">False</span>
        <span class="n">isJunk</span> <span class="kr">_</span>                  <span class="ow">=</span> <span class="kt">True</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>This takes a processed search query (the output of <code>parseSearch</code>) and it
returns a SQL statement that takes those terms and returns the parameters
contained in <code>SearchResult</code>. It also returns the terms as <code>SqlValue</code>s.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">buildQuery</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">String</span><span class="p">,</span> <span class="p">[</span><span class="kt">SqlValue</span><span class="p">])</span>
<span class="nf">buildQuery</span> <span class="n">queryTerms</span> <span class="ow">=</span>
    <span class="p">(</span><span class="kt">L</span><span class="o">.</span><span class="n">concat</span> <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">reverse</span> <span class="o">.</span> <span class="p">(</span><span class="n">suffix</span><span class="kt">:</span><span class="p">)</span> <span class="o">$</span> <span class="n">wheres</span> <span class="o">++</span> <span class="n">sqlList</span><span class="p">,</span> <span class="kt">L</span><span class="o">.</span><span class="n">reverse</span> <span class="n">params</span><span class="p">)</span>
    <span class="kr">where</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>The initial state for the fold</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">init</span> <span class="ow">=</span> <span class="p">([</span><span class="n">prefix</span><span class="p">],</span> <span class="kt">[]</span><span class="p">,</span> <span class="kt">[]</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The results of the folding the query terms to accumulate the
intermediate output.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">(</span><span class="n">sqlList</span><span class="p">,</span> <span class="n">wheres</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">L</span><span class="o">.</span><span class="n">foldl&#39;</span> <span class="n">foldTerm</span> <span class="n">init</span> <span class="o">.</span> <span class="n">zip</span> <span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="p">]</span> <span class="o">$</span> <span class="n">queryTerms</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>This is the prefix for all queries.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">prefix</span> <span class="ow">=</span> <span class="s">&quot;SELECT DISTINCT m.id, u.username, m.posted, m.text</span><span class="se">\</span>
<span class="se">                 \</span><span class="s"> FROM message m</span><span class="se">\</span>
<span class="se">                 \</span><span class="s"> JOIN user u ON u.id=m.user_id&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>This is the suffix for all queries.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">suffix</span> <span class="ow">=</span> <span class="s">&quot; ORDER BY m.posted DESC LIMIT 25;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>This creates a join clause for a given item in the term list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">join</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
        <span class="n">join</span> <span class="n">n</span> <span class="ow">=</span> <span class="s">&quot; JOIN position p&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot; ON p&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot;.message_id=m.id</span><span class="se">\</span>
<span class="se">                 \</span><span class="s"> JOIN token t&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot; ON t&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot;.id=p&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot;.token_id&quot;</span>
            <span class="kr">where</span> <span class="n">n&#39;</span> <span class="ow">=</span> <span class="n">show</span> <span class="n">n</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>This creates a where clause for a given item in the term list.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="n">where_</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span>
        <span class="n">where_</span> <span class="n">n</span> <span class="n">term</span> <span class="ow">=</span> <span class="n">intro</span> <span class="o">++</span> <span class="s">&quot; t&quot;</span> <span class="o">++</span> <span class="n">n&#39;</span> <span class="o">++</span> <span class="s">&quot;.text&quot;</span> <span class="o">++</span> <span class="n">op</span> <span class="o">++</span> <span class="s">&quot;?&quot;</span>
            <span class="kr">where</span> <span class="n">intro</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">n</span> <span class="kr">of</span>
                            <span class="mi">0</span> <span class="ow">-&gt;</span> <span class="s">&quot; WHERE&quot;</span>
                            <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="s">&quot; AND&quot;</span>
                  <span class="n">op</span>    <span class="ow">=</span> <span class="kr">case</span> <span class="p">(</span><span class="sc">&#39;%&#39;</span> <span class="p">`</span><span class="n">elem</span><span class="p">`</span> <span class="n">term</span><span class="p">)</span> <span class="kr">of</span>
                            <span class="kt">True</span>  <span class="ow">-&gt;</span> <span class="s">&quot; LIKE &quot;</span>
                            <span class="kt">False</span> <span class="ow">-&gt;</span> <span class="s">&quot;=&quot;</span>
                  <span class="n">n&#39;</span> <span class="ow">=</span> <span class="n">show</span> <span class="n">n</span>

        <span class="n">foldTerm</span> <span class="ow">::</span> <span class="p">([</span><span class="kt">String</span><span class="p">],</span> <span class="p">[</span><span class="kt">String</span><span class="p">],</span> <span class="p">[</span><span class="kt">SqlValue</span><span class="p">])</span>
                 <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">String</span><span class="p">)</span>
                 <span class="ow">-&gt;</span> <span class="p">([</span><span class="kt">String</span><span class="p">],</span> <span class="p">[</span><span class="kt">String</span><span class="p">],</span> <span class="p">[</span><span class="kt">SqlValue</span><span class="p">])</span>
        <span class="n">foldTerm</span> <span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">wheres</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="ow">=</span>
            <span class="p">((</span><span class="n">join</span> <span class="n">n</span> <span class="kt">:</span> <span class="n">sql</span><span class="p">),</span> <span class="p">(</span><span class="n">where_</span> <span class="n">n</span> <span class="n">term</span> <span class="kt">:</span> <span class="n">wheres</span><span class="p">),</span> <span class="p">(</span><span class="n">toSql</span> <span class="n">term</span><span class="p">)</span> <span class="kt">:</span> <span class="n">params</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 