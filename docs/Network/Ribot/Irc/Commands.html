<!DOCTYPE html>  <html> <head>   <title>Commands.hs</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Commands.hs             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Has the <code>eval</code> function and the definitions of the IRC <code>!</code> commands.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">module</span> <span class="nn">Network.Ribot.Irc.Commands</span>
    <span class="p">(</span> <span class="nf">eval</span>
    <span class="p">,</span> <span class="nf">ribotVersion</span>
    <span class="p">,</span> <span class="nf">privmsg</span>
    <span class="p">,</span> <span class="nf">write</span>
    <span class="p">,</span> <span class="nf">sendResultsToIrc</span>
    <span class="p">)</span> <span class="kr">where</span>

<span class="kr">import</span>           <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">mapM_</span><span class="p">,</span> <span class="nf">liftM</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Control.Monad.Reader</span>
<span class="kr">import</span>           <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.List</span> <span class="k">as</span> <span class="n">L</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Maybe</span> <span class="k">as</span> <span class="n">M</span>
<span class="kr">import</span>           <span class="nn">Data.Time</span>
<span class="kr">import</span>           <span class="nn">Database.HDBC</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><a href="../../../Database/Ribot.html">Database.Ribot</a> <br />
<a href="../PasteBin.html">Network.Ribot.PasteBin</a> <br />
<a href="../Search.html">Network.Ribot.Search</a> <br />
<a href="../Types.html">Network.Ribot.Types</a> <br />
<a href="../../../Text/Ribot/Generate.html">Text.Ribot.Generate</a> <br /></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kr">import</span>           <span class="nn">Database.Ribot</span> <span class="p">(</span><span class="nf">getUserMessages</span><span class="p">)</span>
<span class="kr">import</span>           <span class="nn">Network.Ribot.PasteBin</span>
<span class="kr">import</span>           <span class="nn">Network.Ribot.Search</span>
<span class="kr">import</span>           <span class="nn">Network.Ribot.Types</span>
<span class="kr">import</span>           <span class="nn">Text.Ribot.Generate</span> <span class="p">(</span><span class="nf">mimic</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This is the version, for the command line and the !version command.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">ribotVersion</span> <span class="ow">::</span> <span class="kt">String</span>
<span class="nf">ribotVersion</span> <span class="ow">=</span>  <span class="s">&quot;0.4.1&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This is the help message for the bot.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">helpMessage</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
<span class="nf">helpMessage</span> <span class="ow">=</span>
    <span class="p">[</span> <span class="s">&quot;I understand these commands:&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!help: Print out this information.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!version: Print out my version.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!uptime: Print out how many seconds I&#39;ve been running without taking a break.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!log off: Stop logging your messages.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!log on: Start logging your messages.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!echo STRING: Right back at&#39;cha.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!search QUERY: Search the logs for one or more terms.&quot;</span>
    <span class="p">,</span> <span class="s">&quot;!mimic USER: Return a short string that mimics a user.&quot;</span>
    <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>This sends a privmsg to the channel the bot's in.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">privmsg</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Net</span> <span class="nb">()</span>
<span class="nf">privmsg</span> <span class="n">s</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">asks</span> <span class="n">botChan</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span>
        <span class="n">write</span> <span class="s">&quot;PRIVMSG&quot;</span> <span class="o">$</span> <span class="n">c</span> <span class="o">++</span> <span class="s">&quot; :&quot;</span> <span class="o">++</span> <span class="n">s</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This writes a command and string to IRC. It also prints them to the screen.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">write</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Net</span> <span class="nb">()</span>
<span class="nf">write</span> <span class="n">s</span> <span class="n">t</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">output</span> <span class="ow">&lt;-</span> <span class="n">return</span> <span class="o">.</span> <span class="n">botOutput</span> <span class="o">=&lt;&lt;</span> <span class="n">get</span>
    <span class="n">io</span> <span class="o">.</span> <span class="n">output</span> <span class="o">$</span> <span class="n">s</span> <span class="o">++</span> <span class="s">&quot; &quot;</span> <span class="o">++</span> <span class="n">t</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>This evaluates the input and runs commands based on it. This is also where
you'd add new commands.</p>

<p>Commands it recognizes now are:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="ow">::</span> <span class="kt">Message</span> <span class="ow">-&gt;</span> <span class="kt">Net</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <ul>
<li><code>!help</code> â€” print this message;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="s">&quot;!help&quot;</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">mapM_</span> <span class="n">privmsg</span> <span class="n">helpMessage</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <ul>
<li><code>!version</code> â€” print out the version of the bot;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="s">&quot;!version&quot;</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">privmsg</span> <span class="o">$</span> <span class="s">&quot;version &quot;</span> <span class="o">++</span> <span class="n">ribotVersion</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <ul>
<li><code>!uptime</code> â€” print how long the bot has been running;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="s">&quot;!uptime&quot;</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">privmsg</span> <span class="o">=&lt;&lt;</span> <span class="n">uptime</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <ul>
<li><code>!log off</code> â€” turn off logging for the user;</li>
<li><code>!log on</code> â€” turn on logging for the user;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="p">(</span><span class="kt">Just</span> <span class="n">usr</span><span class="p">)</span> <span class="kr">_</span> <span class="kr">_</span> <span class="n">log</span><span class="p">)</span> <span class="o">|</span> <span class="s">&quot;!log &quot;</span> <span class="p">`</span><span class="kt">L</span><span class="o">.</span><span class="n">isPrefixOf</span><span class="p">`</span> <span class="n">log</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">db</span> <span class="ow">&lt;-</span> <span class="n">gets</span> <span class="n">botDbHandle</span>
    <span class="n">io</span> <span class="o">.</span> <span class="n">withTransaction</span> <span class="n">db</span> <span class="o">$</span> <span class="nf">\</span><span class="n">cxn</span> <span class="ow">-&gt;</span>
        <span class="n">setUserLogging</span> <span class="n">cxn</span> <span class="n">usr</span> <span class="n">logFlag</span>
    <span class="n">privmsg</span> <span class="o">$</span> <span class="s">&quot;Logging turned &quot;</span> <span class="o">++</span> <span class="n">logMsg</span> <span class="o">++</span> <span class="s">&quot; for &quot;</span> <span class="o">++</span> <span class="n">usr</span> <span class="o">++</span> <span class="s">&quot;.&quot;</span>
    <span class="kr">where</span> <span class="n">logFlag</span> <span class="ow">=</span> <span class="n">log</span> <span class="o">==</span> <span class="s">&quot;!log on&quot;</span>
          <span class="n">logMsg</span>  <span class="ow">=</span> <span class="kr">if</span> <span class="n">logFlag</span> <span class="kr">then</span> <span class="s">&quot;on&quot;</span> <span class="kr">else</span> <span class="s">&quot;off&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <ul>
<li><code>!echo NAME</code> â€” echo back;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="s">&quot;!echo&quot;</span> <span class="p">`</span><span class="kt">L</span><span class="o">.</span><span class="n">isPrefixOf</span><span class="p">`</span> <span class="n">x</span> <span class="ow">=</span>
    <span class="n">privmsg</span> <span class="p">(</span><span class="n">drop</span> <span class="mi">6</span> <span class="n">x</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <ul>
<li><code>!search TERMS</code> â€” This searches the log and prints out the last 25
results;</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="n">u</span> <span class="kr">_</span> <span class="kr">_</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="s">&quot;!search&quot;</span> <span class="p">`</span><span class="kt">L</span><span class="o">.</span><span class="n">isPrefixOf</span><span class="p">`</span> <span class="n">x</span> <span class="ow">=</span>
    <span class="n">gets</span> <span class="n">botDbHandle</span> <span class="o">&gt;&gt;=</span> <span class="n">io</span> <span class="o">.</span> <span class="p">(</span><span class="n">flip</span> <span class="n">search</span><span class="p">)</span> <span class="n">query</span> <span class="o">&gt;&gt;=</span> <span class="n">sendResultsToIrc</span> <span class="n">user</span>
    <span class="kr">where</span> <span class="n">query</span> <span class="ow">=</span> <span class="n">drop</span> <span class="mi">8</span> <span class="n">x</span>
          <span class="n">user</span>  <span class="ow">=</span> <span class="kt">M</span><span class="o">.</span><span class="n">fromMaybe</span> <span class="s">&quot;???&quot;</span> <span class="n">u</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <ul>
<li><code>!mimic USER</code> â€” This outputs ten tokens that mimic USER according to a
very simple probabilistic model.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="s">&quot;!mimic&quot;</span> <span class="p">`</span><span class="kt">L</span><span class="o">.</span><span class="n">isPrefixOf</span><span class="p">`</span> <span class="n">x</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">db</span>       <span class="ow">&lt;-</span> <span class="n">gets</span> <span class="n">botDbHandle</span>
    <span class="n">tokens</span>   <span class="ow">&lt;-</span> <span class="n">io</span> <span class="o">$</span> <span class="kr">do</span>
        <span class="n">getUserMessages</span> <span class="n">db</span> <span class="n">user</span> <span class="o">&gt;&gt;=</span> <span class="n">return</span> <span class="o">.</span> <span class="n">map</span> <span class="n">snd</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">flip</span> <span class="n">mimic</span><span class="p">)</span> <span class="mi">12</span>
    <span class="n">privmsg</span> <span class="o">$</span> <span class="kt">L</span><span class="o">.</span><span class="n">intercalate</span> <span class="s">&quot; &quot;</span> <span class="n">tokens</span>
    <span class="kr">where</span> <span class="n">user</span> <span class="ow">=</span> <span class="n">drop</span> <span class="mi">7</span> <span class="n">x</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <ul>
<li>All other <code>!</code> commands are ignored; and</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="p">(</span><span class="kt">Message</span> <span class="kr">_</span> <span class="kr">_</span> <span class="kr">_</span> <span class="p">(</span><span class="sc">&#39;!&#39;</span><span class="kt">:</span><span class="kr">_</span><span class="p">))</span> <span class="ow">=</span> <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <ul>
<li>All other messages are handled by <code>processMessage</code>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">eval</span> <span class="n">msg</span> <span class="ow">=</span> <span class="n">processMessage</span> <span class="n">msg</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This gets how long the bot has been running and returns it as a string.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">uptime</span> <span class="ow">::</span> <span class="kt">Net</span> <span class="kt">String</span>
<span class="nf">uptime</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">now</span>  <span class="ow">&lt;-</span> <span class="n">io</span> <span class="n">getCurrentTime</span>
    <span class="n">zero</span> <span class="ow">&lt;-</span> <span class="n">return</span> <span class="o">.</span> <span class="n">botStartTime</span> <span class="o">=&lt;&lt;</span> <span class="n">get</span>
    <span class="n">return</span> <span class="o">.</span> <span class="n">show</span> <span class="o">$</span> <span class="n">diffUTCTime</span> <span class="n">now</span> <span class="n">zero</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This processes an incoming message.</p>

<p>Currently, this means that we log it to the database and add its tokens to
the inverted index.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">processMessage</span> <span class="ow">::</span> <span class="kt">Message</span> <span class="ow">-&gt;</span> <span class="kt">Net</span> <span class="nb">()</span>
<span class="nf">processMessage</span> <span class="n">msg</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">db</span> <span class="ow">&lt;-</span> <span class="n">gets</span> <span class="n">botDbHandle</span>
    <span class="n">io</span> <span class="o">.</span> <span class="n">withTransaction</span> <span class="n">db</span> <span class="o">$</span> <span class="nf">\</span><span class="n">cxn</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">mId</span> <span class="ow">&lt;-</span> <span class="n">logMessage</span> <span class="n">msg</span> <span class="n">cxn</span>
        <span class="kr">case</span> <span class="n">mId</span> <span class="kr">of</span>
            <span class="kt">Just</span> <span class="n">mId&#39;</span> <span class="ow">-&gt;</span>
                <span class="n">index</span> <span class="n">cxn</span> <span class="p">(</span><span class="kt">M</span><span class="o">.</span><span class="n">fromMaybe</span> <span class="s">&quot;&quot;</span> <span class="o">$</span> <span class="n">msgUser</span> <span class="n">msg</span><span class="p">)</span> <span class="n">mId&#39;</span> <span class="o">$</span> <span class="n">msgText</span> <span class="n">msg</span>
            <span class="kt">Nothing</span>   <span class="ow">-&gt;</span> <span class="n">return</span> <span class="kt">[]</span>
        <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>This checks that a user exists in the database, and inserts it if necessary.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">checkUser</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">checkUser</span> <span class="n">cxn</span> <span class="n">nick</span> <span class="ow">=</span>
    <span class="n">run</span> <span class="n">cxn</span> <span class="s">&quot;INSERT OR IGNORE INTO user </span><span class="se">\</span>
<span class="se">            \</span><span class="s"> (username, logging_on) VALUES </span><span class="se">\</span>
<span class="se">            \</span><span class="s"> (?, 1);&quot;</span>
            <span class="p">[</span><span class="n">toSql</span> <span class="n">nick</span><span class="p">]</span> <span class="o">&gt;&gt;</span>
    <span class="n">return</span> <span class="nb">()</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This saves a message to the database. This doesn't handle the transaction.
You probably want to do that at a higher level.</p>

<p>This returns the ID of the message in the <code>message</code> database or Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">logMessage</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="kt">Message</span> <span class="ow">-&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">Int</span><span class="p">)</span>
<span class="nf">logMessage</span> <span class="n">msg</span> <span class="n">cxn</span> <span class="ow">=</span> <span class="kr">do</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If there's no user, move on.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kr">case</span> <span class="p">(</span><span class="n">msgUser</span> <span class="n">msg</span><span class="p">)</span> <span class="kr">of</span>
        <span class="kt">Just</span> <span class="n">userName</span> <span class="ow">-&gt;</span> <span class="n">addMsg</span> <span class="n">userName</span> <span class="o">$</span> <span class="n">msgText</span> <span class="n">msg</span>
        <span class="kt">Nothing</span>       <span class="ow">-&gt;</span> <span class="n">return</span> <span class="kt">Nothing</span>

    <span class="kr">where</span>
        <span class="n">addMsg</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">Int</span><span class="p">)</span>
        <span class="n">addMsg</span> <span class="n">userName</span> <span class="n">msgStr</span> <span class="ow">=</span> <span class="kr">do</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>First, try to create the user, if the name isn't already in the db.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">checkUser</span> <span class="n">cxn</span> <span class="n">userName</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Second, add the message to the database.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="n">run</span> <span class="n">cxn</span> <span class="s">&quot;INSERT INTO message (user_id, text, posted) </span><span class="se">\</span>
<span class="se">                \</span><span class="s"> SELECT id, ?, DATETIME(&#39;NOW&#39;) </span><span class="se">\</span>
<span class="se">                \</span><span class="s"> FROM user WHERE username=? AND logging_on=1;&quot;</span>
                <span class="p">[</span><span class="n">toSql</span> <span class="n">msgStr</span><span class="p">,</span> <span class="n">toSql</span> <span class="n">userName</span><span class="p">]</span>
            <span class="n">msgId</span> <span class="ow">&lt;-</span> <span class="n">quickQuery&#39;</span> <span class="n">cxn</span> <span class="s">&quot;SELECT last_insert_rowid();&quot;</span> <span class="kt">[]</span>
            <span class="n">return</span> <span class="o">$</span> <span class="kr">case</span> <span class="n">msgId</span> <span class="kr">of</span>
                <span class="p">[[</span><span class="n">sqlId</span><span class="p">]]</span> <span class="ow">-&gt;</span> <span class="kt">Just</span> <span class="o">$</span> <span class="n">fromSql</span> <span class="n">sqlId</span>
                <span class="kr">_</span>         <span class="ow">-&gt;</span> <span class="kt">Nothing</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>This sets the user.logging_on value for the given user.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">setUserLogging</span> <span class="ow">::</span> <span class="kt">IConnection</span> <span class="n">c</span> <span class="ow">=&gt;</span> <span class="n">c</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">setUserLogging</span> <span class="n">cxn</span> <span class="n">nick</span> <span class="n">loggingOn</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">checkUser</span> <span class="n">cxn</span> <span class="n">nick</span>
    <span class="n">run</span> <span class="n">cxn</span> <span class="s">&quot;UPDATE user </span><span class="se">\</span>
<span class="se">            \</span><span class="s"> SET logging_on=? </span><span class="se">\</span>
<span class="se">            \</span><span class="s"> WHERE username=?;&quot;</span>
        <span class="p">[</span><span class="n">iToSql</span> <span class="n">loggingInt</span><span class="p">,</span> <span class="n">toSql</span> <span class="n">nick</span><span class="p">]</span>
    <span class="n">return</span> <span class="nb">()</span>
    <span class="kr">where</span> <span class="n">loggingInt</span> <span class="ow">=</span> <span class="kr">if</span> <span class="n">loggingOn</span> <span class="kr">then</span> <span class="mi">1</span> <span class="kr">else</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>This sends the results to IRC. Depending on the number of results, this may
actually involve posting the results to http://pastebin.com with a message,
or if there is no deverloper's API key for Pastebin, just outputting a
sorry and a few.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nf">sendResultsToIrc</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">SearchResult</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Net</span> <span class="nb">()</span>
<span class="nf">sendResultsToIrc</span> <span class="kr">_</span> <span class="n">results</span> <span class="o">|</span> <span class="p">(</span><span class="n">length</span> <span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">=</span>
    <span class="n">mapM_</span> <span class="p">(</span><span class="n">privmsg</span> <span class="o">.</span> <span class="n">showSearchResult</span><span class="p">)</span> <span class="n">results</span>
<span class="nf">sendResultsToIrc</span> <span class="n">nick</span> <span class="n">results</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">maybePasteBinKey</span> <span class="ow">&lt;-</span> <span class="n">asks</span> <span class="n">botPasteBinKey</span>
    <span class="kr">case</span> <span class="n">maybePasteBinKey</span> <span class="kr">of</span>
        <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
            <span class="n">privmsg</span> <span class="p">(</span><span class="s">&quot;There were &quot;</span> <span class="o">++</span> <span class="p">(</span><span class="n">show</span> <span class="o">$</span> <span class="n">length</span> <span class="n">results</span><span class="p">)</span> <span class="o">++</span> <span class="s">&quot; results.</span><span class="se">\</span>
<span class="se">                     \</span><span class="s"> But I don&#39;t know how to post to PasteBin, so here</span><span class="se">\</span>
<span class="se">                     \</span><span class="s"> are two:&quot;</span><span class="p">)</span>
            <span class="n">mapM_</span> <span class="p">(</span><span class="n">privmsg</span> <span class="o">.</span> <span class="n">showSearchResult</span><span class="p">)</span> <span class="o">$</span> <span class="kt">L</span><span class="o">.</span><span class="n">take</span> <span class="mi">2</span> <span class="n">results</span>
        <span class="kt">Just</span> <span class="n">key</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
            <span class="n">url</span> <span class="ow">&lt;-</span>   <span class="n">io</span>
                   <span class="o">.</span> <span class="n">createPaste</span> <span class="n">key</span> <span class="n">title</span>
                   <span class="o">.</span> <span class="kt">L</span><span class="o">.</span><span class="n">unlines</span>
                   <span class="o">$</span> <span class="n">map</span> <span class="n">showSearchResult</span> <span class="n">results</span>
            <span class="n">privmsg</span> <span class="p">(</span><span class="n">nick</span> <span class="o">++</span> <span class="s">&quot;, &quot;</span> <span class="o">++</span> <span class="p">(</span><span class="n">show</span> <span class="o">$</span> <span class="n">length</span> <span class="n">results</span><span class="p">)</span> <span class="o">++</span>
                     <span class="s">&quot; results: &quot;</span> <span class="o">++</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">privmsg</span> <span class="s">&quot;That will be available for about an hour.&quot;</span>
            <span class="kr">where</span> <span class="n">title</span> <span class="ow">=</span> <span class="s">&quot;Search for &quot;</span> <span class="o">++</span> <span class="n">nick</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 